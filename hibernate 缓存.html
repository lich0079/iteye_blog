<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>缓存可以简单的看成<span style="color: red;">一个</span> </span> <span style="color: red;"><span style="font-family: Times New Roman;">Map</span> </span> <span>，<span style="color: red;">通过</span> </span> <span style="color: red;"><span style="font-family: Times New Roman;">key</span> </span> <span>在缓存里面<span style="color: red;">找</span> </span> <span style="color: red;"><span style="font-family: Times New Roman;">value</span> </span> <span>。</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>一、缓存简介</span> <span><span style="font-family: Times New Roman;"><span>&nbsp; </span> <strong>Cache In Hibernate</strong> <br> HIBERNATE</span> </span> <span>中的</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> <span>有两级</span> <span><span style="font-family: Times New Roman;">. </span> </span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>一级是在</span> <strong><span><span style="font-family: Times New Roman;">Session</span> </span> </strong> <strong><span>范围内的</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> </strong> <span><span style="font-family: Times New Roman;">. </span> </span> <span>即每个</span> <span><span style="font-family: Times New Roman;">Session</span> </span> <span>有自己的一个</span> <span><span style="font-family: Times New Roman;">CACHE, </span> </span> <span>当前操作的对象都会被保留在</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> <span>中</span> <span><span style="font-family: Times New Roman;">. </span> </span> <span>但是</span> <span><span style="font-family: Times New Roman;">Session</span> </span> <span>关闭后这个</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> <span>也就没有</span> <span><span style="font-family: Times New Roman;">. </span> </span> <span>可见这级</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> <span>的生命期是很短的</span> <span><span style="font-family: Times New Roman;">. </span> </span> <span>（使用</span> <span><span style="font-family: Times New Roman;">id</span> </span> <span>进行关键字存储：缓存的</span> <span><span style="font-family: Times New Roman;">key</span> </span> <span>就是</span> <span><span style="font-family: Times New Roman;">ID</span> </span> <span>，</span> <span><span style="font-family: Times New Roman;">value</span> </span> <span>是</span> <span><span style="font-family: Times New Roman;">POJO</span> </span> <span>）</span> <span><span style="font-family: Times New Roman;">(</span> </span> <span>缓存的是实体对象</span> <span><span style="font-family: Times New Roman;">)</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>另一级</span> <strong><span><span style="font-family: Times New Roman;">CACHE</span> </span> </strong> <strong><span>是在</span> <span><span style="font-family: Times New Roman;">SessionFactory</span> </span> </strong> <strong><span>范围的</span> </strong> <span><span style="font-family: Times New Roman;">, </span> </span> <span>可以被来自同一个</span> <span><span style="font-family: Times New Roman;">SessionFactory</span> </span> <span>的</span> <span><span style="font-family: Times New Roman;">Session</span> </span> <span>共享</span> <span><span style="font-family: Times New Roman;">. </span> </span> <span>在</span> <span><span style="font-family: Times New Roman;">HIBERNATE</span> </span> <span>的文档中称其为</span> <span><span style="font-family: Times New Roman;">SECOND LEVEL CACHE. </span> </span> <span>显然后者的优势较明显</span> <span><span style="font-family: Times New Roman;">, </span> </span> <span>也比较复合当前的使用环境</span> <span><span style="font-family: Times New Roman;">. <span>&nbsp;&nbsp;</span> </span> </span> <span>它可以使用不同的缓存实现，如</span> <span><span style="font-family: Times New Roman;">EhCache</span> </span> <span>、</span> <span><span style="font-family: Times New Roman;">JBossCache</span> </span> <span>、</span> <span><span style="font-family: Times New Roman;">OsCache</span> </span> <span>等</span> <span>（二级缓存是缓存实体对象的）</span> <span><br><br></span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>还有一个类型的</span> <span><span style="font-family: Times New Roman;">CACHE</span> </span> <span>就是</span> <span style="font-family: Times New Roman;"><strong><span>QueryCache</span> </strong> <span>. </span> </span> <span>它的作用就是缓存一个</span> <span><span style="font-family: Times New Roman;">Query</span> </span> <span>以及</span> <span><span style="font-family: Times New Roman;">Query</span> </span> <span>返回对象的</span> <span><span style="font-family: Times New Roman;">Identifier</span> </span> <span>以及对象的类型</span> <span><span style="font-family: Times New Roman;">. </span> </span> <span>有了</span> <span><span style="font-family: Times New Roman;">QueryCache</span> </span> <span>后就可以高效的使用</span> <span><span style="font-family: Times New Roman;">SECOND LEVEL CACHE.</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt 21pt;" class="MsoNormal"><span class="hilite1"><span><span style="background-color: #ffff00;"><span style="font-family: Times New Roman;">hibernate</span> </span> </span> </span> <span>查询缓存</span> <span><span style="font-family: Times New Roman;">(<span class="hilite1"><span style="background-color: #ffff00;">hibernate</span> </span> </span> </span> <span>默认是关闭的</span> <span><span style="font-family: Times New Roman;">) <br></span> </span> <span>查询缓存是针对普通属性结果集的缓存</span> <span><span style="font-family: Times New Roman;"><br></span> </span> <span>对实体对象的结果集只缓存</span> <span><span style="font-family: Times New Roman;">id <br></span> </span> <span>查询缓存的生命周期，当前关联的表发生修改，那么查询缓存生命周期结束</span> <span><span style="font-family: Times New Roman;"><br></span> </span> <span>查询缓存的配置和使用：</span> <span><span style="font-family: Times New Roman;"><br> 1. </span> </span> <span>启用查询缓存：在</span> <span style="font-family: Times New Roman;"><span class="hilite1"><span style="background-color: #ffff00;"><span>hibernate</span> </span> </span> <span>.cfg.xml</span> </span> <span>中加入：</span> <span><span style="font-family: Times New Roman;"><br> &lt;property name=”<span class="hilite1"><span style="background-color: #ffff00;">hibernate</span> </span> .cache.use_query_cache”&gt;true&lt;/property&gt; <br> 2. </span> </span> <span>在程序中必须手动启用查询缓存，如：</span> <span><span style="font-family: Times New Roman;">query.setCacheable(true);</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">QueryCache</span> </span> <span>用来缓存查询语句</span> <span><span style="font-family: Times New Roman;">, </span> </span> <span>及查询结果集中对象的</span> <span><span style="font-family: Times New Roman;">Identifier</span> </span> <span>与</span> <span><span style="font-family: Times New Roman;">Type. </span> </span> <span>当再次使用已缓存的</span> <span><span style="font-family: Times New Roman;">Query</span> </span> <span>时</span> <span><span style="font-family: Times New Roman;">, </span> </span> <span>就可以通过对象的</span> <span><span style="font-family: Times New Roman;">Identifier</span> </span> <span>与</span> <span><span style="font-family: Times New Roman;">Type</span> </span> <span>在</span> <span><span style="font-family: Times New Roman;">SECOND LEVEL CACHE</span> </span> <span>中查找实际的对象</span> <span><span style="font-family: Times New Roman;">.</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>对于查询缓存来说，缓存的</span> <span><span style="font-family: Times New Roman;">key</span> </span> <span>是根据</span> <span><span style="font-family: Times New Roman;">hql</span> </span> <span>生成的</span> <span><span style="font-family: Times New Roman;">sql</span> </span> <span>，再加上参数，分页等信息（可以通过日志输出看到，不过它的输出不是很可读，最好改一下它的代码）。</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>注：一级缓存也叫</span> <span><span style="font-family: Times New Roman;">session</span> </span> <span>级的缓存或事务缓存。</span> <span><span style="font-family: Times New Roman;">Hibernate</span> </span> <span>二级缓存也称为进程级的缓存或</span> <span><span style="font-family: Times New Roman;">SessionFactory</span> </span> <span>级的缓存。二级缓存是全局缓存，它可以被所有的</span> <span><span style="font-family: Times New Roman;">session</span> </span> <span>共享。二级缓存的生命周期和</span> <span><span style="font-family: Times New Roman;">SessionFactory</span> </span> <span>的生命周期一致，</span> <span><span style="font-family: Times New Roman;">SessionFactory</span> </span> <span>可以管理二级缓存。</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>二、缓存的范围</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>缓存的范围分为</span> <span><span style="font-family: Times New Roman;">3</span> </span> <span>类</span> <span><span style="font-family: Times New Roman;">: <br> 1.</span> </span> <span>事务范围</span> <span><span style="font-family: Times New Roman;"><br> &nbsp;&nbsp; <span>&nbsp;&nbsp;</span> </span> </span> <span>事务范围的缓存只能被当前事务访问</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>每个事务都有各自的缓存</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存内的数据通常采用相互关联的对象形式</span> <span><span style="font-family: Times New Roman;">.</span> </span> <span>缓存的生命周期依赖于事务的生命周期</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>只有当事务结束时</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存的生命周期才会结束</span> <span><span style="font-family: Times New Roman;">.</span> </span> <span>事务范围的缓存使用内存作为存储介质</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>一级缓存就属于事务范围</span> <span><span style="font-family: Times New Roman;">. <br> 2.</span> </span> <span>应用范围</span> <span><span style="font-family: Times New Roman;"><br> &nbsp;&nbsp;<span>&nbsp; </span> <span>&nbsp;</span> </span> </span> <span>应用程序的缓存可以被应用范围内的所有事务共享访问</span> <span><span style="font-family: Times New Roman;">.</span> </span> <span>缓存的生命周期依赖于应用的生命周期</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>只有当应用结束时</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存的生命周期才会结束</span> <span><span style="font-family: Times New Roman;">.</span> </span> <span>应用范围的缓存可以使用内存或硬盘作为存储介质</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>二级缓存就属于应用范围</span> <span><span style="font-family: Times New Roman;">. <br> 3.</span> </span> <span>集群范围</span> <span><span style="font-family: Times New Roman;"><br> &nbsp;&nbsp; <span>&nbsp;&nbsp;</span> </span> </span> <span>在集群环境中</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存被一个机器或多个机器的进程共享</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存中的数据被复制到集群环境中的每个进程节点</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>进程间通过远程通信来保证缓存中的数据的一致</span> <span><span style="font-family: Times New Roman;">,</span> </span> <span>缓存中的数据通常采用对象的松散数据形式</span> <span><span style="font-family: Times New Roman;">. <br><br></span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>三、缓存的方式</span> </p> 
<p style="margin: 0cm 0cm 0pt; text-indent: 21pt;" class="MsoNormal"><span>有四种，分别为：</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">CacheConcurrencyStrategy.NONE</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">CacheConcurrencyStrategy.READ_ONLY</span> </span> <span>，只读模式，在此模式下，如果对数据进行更新操作，会有异常；</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">CacheConcurrencyStrategy.READ_WRITE</span> </span> <span>，读写模式在更新缓存的时候会把缓存里面的数据换成一个锁，其它事务如果去取相应的缓存数据，发现被锁了，直接就去数据库查询；</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">CacheConcurrencyStrategy.NONSTRICT_READ_WRITE</span> </span> <span>，不严格的读写模式则不会的缓存数据加锁；</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">CacheConcurrencyStrategy.TRANSACTIONAL</span> </span> <span>，事务模式指缓存支持事务，当事务回滚时，缓存也能回滚，只支持</span> <span><span style="font-family: Times New Roman;">JTA</span> </span> <span>环境。</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span><span style="font-family: Times New Roman;">&nbsp;</span> </span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>缓存的注释写法如下，加在</span> <span><span style="font-family: Times New Roman;">Entity</span> </span> <span>的</span> <span><span style="font-family: Times New Roman;">java</span> </span> <span>类上：</span> </p> 
<p style="margin: 0cm 0cm 0pt;" class="MsoNormal"><span>　　</span> <span><span style="font-family: Times New Roman;">@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)</span> </span> </p>